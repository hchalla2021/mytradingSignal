#!/usr/bin/env python3\n\"\"\"\nüî• PRODUCTION WEBSOCKET TEST SCRIPT\nTest the new production-grade Zerodha WebSocket manager\n\"\"\"\n\nimport asyncio\nimport time\nfrom datetime import datetime\nfrom services.zerodha_websocket_manager import ZerodhaWebSocketManager\nfrom config import get_settings\n\nsettings = get_settings()\n\ndef test_websocket_manager():\n    \"\"\"Test the production WebSocket manager\"\"\"\n    \n    print(\"üî• TESTING PRODUCTION ZERODHA WEBSOCKET MANAGER\")\n    print(\"=\" * 50)\n    \n    # Check settings\n    if not settings.zerodha_api_key:\n        print(\"‚ùå ZERODHA_API_KEY not set\")\n        return\n        \n    if not settings.zerodha_access_token:\n        print(\"‚ùå ZERODHA_ACCESS_TOKEN not set\")\n        print(\"üí° Run authentication first\")\n        return\n    \n    print(f\"‚úÖ API Key: {settings.zerodha_api_key[:8]}...\")\n    print(f\"‚úÖ Access Token: {settings.zerodha_access_token[:8]}...\")\n    \n    instruments = [settings.nifty_token, settings.banknifty_token, settings.sensex_token]\n    print(f\"üìä Instruments: {instruments}\")\n    \n    # Callbacks\n    tick_count = 0\n    status_updates = []\n    \n    def on_tick(ticks):\n        nonlocal tick_count\n        tick_count += len(ticks)\n        for tick in ticks:\n            symbol = 'UNKNOWN'\n            if tick.get('instrument_token') == settings.nifty_token:\n                symbol = 'NIFTY'\n            elif tick.get('instrument_token') == settings.banknifty_token:\n                symbol = 'BANKNIFTY'\n            elif tick.get('instrument_token') == settings.sensex_token:\n                symbol = 'SENSEX'\n                \n            print(f\"üìà {symbol}: ‚Çπ{tick.get('last_price', 0)} (Total ticks: {tick_count})\")\n    \n    def on_status(status, message):\n        timestamp = datetime.now().strftime('%H:%M:%S')\n        status_updates.append((timestamp, status, message))\n        print(f\"üì° [{timestamp}] {status}: {message}\")\n    \n    # Initialize manager\n    print(\"\\nüöÄ Initializing WebSocket Manager...\")\n    ws_manager = ZerodhaWebSocketManager(\n        api_key=settings.zerodha_api_key,\n        access_token=settings.zerodha_access_token,\n        instruments=instruments\n    )\n    \n    ws_manager.set_callbacks(on_tick, on_status)\n    \n    print(\"\\nüîó Starting connection...\")\n    print(\"‚è∞ This will wait for proper market timing (9:14:50 AM)\")\n    print(\"üîÑ Press Ctrl+C to stop\\n\")\n    \n    try:\n        # Test connection\n        ws_manager.connect()  # This will block\n        \n    except KeyboardInterrupt:\n        print(\"\\nüõë Stopping test...\")\n    except Exception as e:\n        print(f\"\\n‚ùå Error: {e}\")\n    finally:\n        ws_manager.disconnect()\n        \n        print(\"\\nüìä TEST RESULTS:\")\n        print(f\"   Total ticks received: {tick_count}\")\n        print(f\"   Status updates: {len(status_updates)}\")\n        \n        if status_updates:\n            print(\"\\nüì° Status Timeline:\")\n            for timestamp, status, message in status_updates[-10:]:  # Last 10\n                print(f\"   [{timestamp}] {status}: {message}\")\n        \n        # Final status\n        final_status = ws_manager.get_status()\n        print(\"\\nüéØ Final Status:\", final_status)\n        \n        if tick_count > 0:\n            print(\"\\n‚úÖ TEST PASSED: Received live market ticks\")\n        else:\n            print(\"\\n‚ö†Ô∏è  TEST INCOMPLETE: No ticks received\")\n            print(\"   This may be normal if market is closed\")\n\nif __name__ == \"__main__\":\n    test_websocket_manager()